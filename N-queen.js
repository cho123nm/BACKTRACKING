import React, { useState, useRef } from "react";
import { Play, Pause, RotateCcw, AlertCircle } from "lucide-react";

const NQueensVisualizer = () => {
  const [n, setN] = useState(4);
  const [board, setBoard] = useState(Array(4).fill(-1));
  const [isRunning, setIsRunning] = useState(false);
  const [speed, setSpeed] = useState(500);
  const [step, setStep] = useState(0);
  const [log, setLog] = useState(["Nh·∫•n 'Ch·∫°y' ƒë·ªÉ b·∫Øt ƒë·∫ßu..."]);
  const [currentRow, setCurrentRow] = useState(-1);
  const [currentCol, setCurrentCol] = useState(-1);
  const [solutions, setSolutions] = useState(0);
  const [attacks, setAttacks] = useState([]);
  const [explanation, setExplanation] = useState(
    "S·∫µn s√†ng b·∫Øt ƒë·∫ßu. Nh·∫•n Play ƒë·ªÉ xem thu·∫≠t to√°n ho·∫°t ƒë·ªông!"
  );

  const runningRef = useRef(false);

  const resetBoard = () => {
    const newSize = n;
    setBoard(Array(newSize).fill(-1));
    setIsRunning(false);
    runningRef.current = false;
    setStep(0);
    setLog(["Nh·∫•n 'Ch·∫°y' ƒë·ªÉ b·∫Øt ƒë·∫ßu..."]);
    setCurrentRow(-1);
    setCurrentCol(-1);
    setSolutions(0);
    setAttacks([]);
    setExplanation("S·∫µn s√†ng b·∫Øt ƒë·∫ßu. Nh·∫•n Play ƒë·ªÉ xem thu·∫≠t to√°n ho·∫°t ƒë·ªông!");
  };

  const handleNChange = (newN) => {
    setN(newN);
    setBoard(Array(newN).fill(-1));
    setStep(0);
    setLog(["Nh·∫•n 'Ch·∫°y' ƒë·ªÉ b·∫Øt ƒë·∫ßu..."]);
    setCurrentRow(-1);
    setCurrentCol(-1);
    setSolutions(0);
    setAttacks([]);
    setExplanation("S·∫µn s√†ng b·∫Øt ƒë·∫ßu. Nh·∫•n Play ƒë·ªÉ xem thu·∫≠t to√°n ho·∫°t ƒë·ªông!");
  };

  const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

  const isSafe = (boardArray, row, col) => {
    const attackCells = [];

    for (let i = 0; i < row; i++) {
      if (boardArray[i] === col) {
        attackCells.push([i, col]);
      }
    }

    for (let i = row - 1, j = col - 1; i >= 0 && j >= 0; i--, j--) {
      if (boardArray[i] === j) {
        attackCells.push([i, j]);
      }
    }

    for (
      let i = row - 1, j = col + 1;
      i >= 0 && j < boardArray.length;
      i--, j++
    ) {
      if (boardArray[i] === j) {
        attackCells.push([i, j]);
      }
    }

    return { safe: attackCells.length === 0, attacks: attackCells };
  };

  const solveStep = async (
    boardArray,
    row,
    logArray,
    stepCounter,
    solutionCounter
  ) => {
    if (!runningRef.current)
      return { stopped: true, solutions: solutionCounter };

    const boardSize = boardArray.length;

    if (row === boardSize) {
      solutionCounter++;
      setSolutions(solutionCounter);
      setExplanation(`üéâ T√¨m ƒë∆∞·ª£c l·ªùi gi·∫£i th·ª© ${solutionCounter}!`);
      logArray.push(`‚úÖ T√¨m ƒë∆∞·ª£c l·ªùi gi·∫£i th·ª© ${solutionCounter}!`);
      setLog([...logArray]);
      await sleep(speed * 2);
      return { stopped: false, solutions: solutionCounter };
    }

    for (let col = 0; col < boardSize; col++) {
      if (!runningRef.current)
        return { stopped: true, solutions: solutionCounter };

      setCurrentRow(row);
      setCurrentCol(col);
      setExplanation(
        `ƒêang th·ª≠ ƒë·∫∑t qu√¢n h·∫≠u t·∫°i h√†ng ${row + 1}, c·ªôt ${col + 1}...`
      );
      await sleep(speed / 2);

      const safetyCheck = isSafe(boardArray, row, col);

      if (safetyCheck.safe) {
        logArray.push(`‚úì H√†ng ${row + 1}, C·ªôt ${col + 1}: AN TO√ÄN`);
        setAttacks([]);
        boardArray[row] = col;
        setBoard([...boardArray]);
        setLog([...logArray]);
        setStep(++stepCounter);
        await sleep(speed);

        const result = await solveStep(
          boardArray,
          row + 1,
          logArray,
          stepCounter,
          solutionCounter
        );
        if (result.stopped) return result;
        solutionCounter = result.solutions;

        setExplanation(`‚¨ÖÔ∏è Quay lui t·ª´ h√†ng ${row + 1}, th·ª≠ v·ªã tr√≠ kh√°c...`);
        logArray.push(`‚¨Ö Quay lui t·ª´ h√†ng ${row + 1}, c·ªôt ${col + 1}`);
        boardArray[row] = -1;
        setBoard([...boardArray]);
        setLog([...logArray]);
        setCurrentRow(row);
        setCurrentCol(col);
        await sleep(speed);
      } else {
        logArray.push(`‚úó H√†ng ${row + 1}, C·ªôt ${col + 1}: B·ªä T·∫§N C√îNG`);
        setAttacks(safetyCheck.attacks);
        setLog([...logArray]);
        setExplanation(`‚ùå V·ªã tr√≠ b·ªã t·∫•n c√¥ng! Th·ª≠ c·ªôt ti·∫øp theo...`);
        await sleep(speed / 2);
        setAttacks([]);
      }
    }

    return { stopped: false, solutions: solutionCounter };
  };

  const startSolving = async () => {
    runningRef.current = true;
    setIsRunning(true);
    const boardArray = Array(n).fill(-1);
    const logArray = ["B·∫Øt ƒë·∫ßu gi·∫£i thu·∫≠t..."];
    setLog(logArray);
    setSolutions(0);
    setStep(0);

    const result = await solveStep(boardArray, 0, logArray, 0, 0);

    runningRef.current = false;
    setIsRunning(false);
    setCurrentRow(-1);
    setCurrentCol(-1);
    setExplanation(`Ho√†n th√†nh! T√¨m ƒë∆∞·ª£c ${result.solutions} l·ªùi gi·∫£i.`);
  };

  const stopSolving = () => {
    runningRef.current = false;
    setIsRunning(false);
    setExplanation("ƒê√£ d·ª´ng!");
  };

  const isAttacked = (row, col) => {
    return attacks.some(([r, c]) => r === row && c === col);
  };

  const isCurrent = (row, col) => {
    return row === currentRow && col === currentCol;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-6">
          <h1 className="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
            M√¥ ph·ªèng N-Queens Backtracking
          </h1>
          <p className="text-center text-gray-600 mb-6">
            Xem tr·ª±c quan c√°ch thu·∫≠t to√°n backtracking gi·∫£i b√†i to√°n x·∫øp N qu√¢n
            h·∫≠u
          </p>

          <div className="flex flex-wrap items-center justify-center gap-4 mb-6">
            <div className="flex items-center gap-2">
              <label className="font-semibold text-gray-700">
                S·ªë qu√¢n h·∫≠u:
              </label>
              <input
                type="number"
                min="4"
                max="8"
                value={n}
                onChange={(e) =>
                  handleNChange(
                    Math.max(4, Math.min(8, parseInt(e.target.value) || 4))
                  )
                }
                disabled={isRunning}
                className="w-16 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
              />
            </div>

            <div className="flex items-center gap-2">
              <label className="font-semibold text-gray-700">T·ªëc ƒë·ªô:</label>
              <input
                type="range"
                min="100"
                max="2000"
                step="100"
                value={speed}
                onChange={(e) => setSpeed(parseInt(e.target.value))}
                className="w-32"
              />
              <span className="text-sm text-gray-600">{speed}ms</span>
            </div>

            {!isRunning ? (
              <button
                onClick={startSolving}
                className="flex items-center gap-2 px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition"
              >
                <Play size={20} /> Ch·∫°y
              </button>
            ) : (
              <button
                onClick={stopSolving}
                className="flex items-center gap-2 px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition"
              >
                <Pause size={20} /> D·ª´ng
              </button>
            )}

            <button
              onClick={resetBoard}
              disabled={isRunning}
              className="flex items-center gap-2 px-6 py-2 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 text-white rounded-lg font-semibold transition"
            >
              <RotateCcw size={20} /> Reset
            </button>
          </div>

          <div className="flex justify-center gap-6 mb-6">
            <div className="bg-blue-100 px-6 py-3 rounded-lg">
              <div className="text-sm text-blue-600 font-semibold">B∆∞·ªõc</div>
              <div className="text-2xl font-bold text-blue-700">{step}</div>
            </div>
            <div className="bg-green-100 px-6 py-3 rounded-lg">
              <div className="text-sm text-green-600 font-semibold">
                L·ªùi gi·∫£i
              </div>
              <div className="text-2xl font-bold text-green-700">
                {solutions}
              </div>
            </div>
            <div className="bg-purple-100 px-6 py-3 rounded-lg">
              <div className="text-sm text-purple-600 font-semibold">
                H√†ng hi·ªán t·∫°i
              </div>
              <div className="text-2xl font-bold text-purple-700">
                {currentRow >= 0 ? `${currentRow + 1}/${n}` : "-"}
              </div>
            </div>
          </div>

          <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <AlertCircle
                className="text-yellow-600 mt-1 flex-shrink-0"
                size={24}
              />
              <div className="text-gray-700 font-medium">{explanation}</div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="flex flex-col items-center">
              <h3 className="text-xl font-bold mb-4 text-gray-800">
                B√†n c·ªù {n}√ó{n}
              </h3>
              <div
                className="inline-grid gap-1 p-4 bg-gray-800 rounded-lg shadow-lg"
                style={{ gridTemplateColumns: `repeat(${n}, minmax(0, 1fr))` }}
              >
                {Array.from({ length: n * n }).map((_, idx) => {
                  const row = Math.floor(idx / n);
                  const col = idx % n;
                  const hasQueen = board[row] === col;
                  const isWhite = (row + col) % 2 === 0;
                  const attacked = isAttacked(row, col);
                  const current = isCurrent(row, col);

                  return (
                    <div
                      key={idx}
                      className={`w-12 h-12 flex items-center justify-center text-2xl transition-all duration-200 ${
                        current
                          ? "bg-yellow-300 scale-110 shadow-lg"
                          : attacked
                          ? "bg-red-400"
                          : isWhite
                          ? "bg-amber-100"
                          : "bg-amber-700"
                      }`}
                    >
                      {hasQueen && <span className="text-3xl">‚ôõ</span>}
                    </div>
                  );
                })}
              </div>

              <div className="mt-4 space-y-2 text-sm">
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 bg-yellow-300 border border-gray-300"></div>
                  <span>√î ƒëang ki·ªÉm tra</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 bg-red-400 border border-gray-300"></div>
                  <span>√î b·ªã t·∫•n c√¥ng</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 bg-amber-100 border border-gray-300 flex items-center justify-center text-lg">
                    ‚ôõ
                  </div>
                  <span>Qu√¢n h·∫≠u</span>
                </div>
              </div>
            </div>

            <div className="flex flex-col">
              <h3 className="text-xl font-bold mb-4 text-gray-800">
                Log thu·∫≠t to√°n
              </h3>
              <div className="bg-gray-900 text-green-400 p-4 rounded-lg h-96 overflow-y-auto font-mono text-sm">
                {log.map((entry, idx) => (
                  <div key={idx} className="mb-1">
                    {entry}
                  </div>
                ))}
              </div>
            </div>
          </div>

          <div className="mt-8 bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg">
            <h3 className="text-2xl font-bold mb-4 text-gray-800">
              Thu·∫≠t to√°n Backtracking ho·∫°t ƒë·ªông th·∫ø n√†o?
            </h3>
            <ol className="space-y-3 text-gray-700 leading-relaxed">
              <li>
                <strong>B∆∞·ªõc 1:</strong> B·∫Øt ƒë·∫ßu t·ª´ h√†ng ƒë·∫ßu ti√™n, th·ª≠ ƒë·∫∑t qu√¢n
                h·∫≠u v√†o t·ª´ng c·ªôt t·ª´ tr√°i sang ph·∫£i.
              </li>
              <li>
                <strong>B∆∞·ªõc 2:</strong> Ki·ªÉm tra xem v·ªã tr√≠ ƒë√≥ c√≥ b·ªã t·∫•n c√¥ng
                b·ªüi qu√¢n h·∫≠u n√†o ·ªü c√°c h√†ng tr∆∞·ªõc kh√¥ng (ki·ªÉm tra c√πng c·ªôt,
                ƒë∆∞·ªùng ch√©o tr√°i v√† ph·∫£i).
              </li>
              <li>
                <strong>B∆∞·ªõc 3:</strong> N·∫øu an to√†n, ƒë·∫∑t qu√¢n h·∫≠u xu·ªëng v√†
                chuy·ªÉn sang h√†ng ti·∫øp theo, l·∫∑p l·∫°i b∆∞·ªõc 1.
              </li>
              <li>
                <strong>B∆∞·ªõc 4:</strong> N·∫øu kh√¥ng an to√†n, th·ª≠ c·ªôt ti·∫øp theo ·ªü
                h√†ng hi·ªán t·∫°i.
              </li>
              <li>
                <strong>B∆∞·ªõc 5 (Backtrack):</strong> N·∫øu ƒë√£ th·ª≠ h·∫øt t·∫•t c·∫£ c·ªôt ·ªü
                h√†ng hi·ªán t·∫°i m√† kh√¥ng c√≥ v·ªã tr√≠ n√†o an to√†n, QUAY L√ôI v·ªÅ h√†ng
                tr∆∞·ªõc, b·ªè qu√¢n h·∫≠u ·ªü ƒë√≥ v√† th·ª≠ v·ªã tr√≠ kh√°c.
              </li>
              <li>
                <strong>B∆∞·ªõc 6:</strong> L·∫∑p l·∫°i cho ƒë·∫øn khi ƒë·∫∑t ƒë∆∞·ª£c {n} qu√¢n
                h·∫≠u ho·∫∑c ƒë√£ th·ª≠ h·∫øt t·∫•t c·∫£ kh·∫£ nƒÉng.
              </li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  );
};

export default NQueensVisualizer;
